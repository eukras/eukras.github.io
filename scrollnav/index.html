
<html>
    <head>
        <title>
            UX DEMO
        </title>
        <meta charset="ISO-8859-1">
        <script src="https://kit.fontawesome.com/350b6fff02.js" crossorigin="anonymous"></script>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:ital,wght@0,400;0,600;1,400;1,600&family=IBM+Plex+Serif:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    </head>
    <body>
        <nav id="site-navigation">
            <div class="sticky sidebar">
                <p><b>UX Demo</b></p>
                <p><small>Lo-Fi JS prototype</small></p><small>
                <ul class="small-text">
                    <li>Show an outline that does not distract from reading</li>
                    <li>Make it easy to return to last reading position</li>
                </ul>
                <p>
                    </p><div><a href="/"><i class="fa fa-home margin-right"></i> Home</a></div>
                <p></p>
                <p>
                    </p><div><a href="#"><i class="fa fa-book margin-right"></i> Menu Item</a></div>
                    <div><a href="#"><i class="fa fa-print margin-right"></i> Menu Item</a></div>
                    <div><a href="#"><i class="fa fa-file margin-right"></i> Menu Item</a></div>
                <p></p>
                <div class="options-box">
                    <div><i class="fa fa-adjust margin-right"></i> <i>Option</i></div>
                    <div><i class="fa fa-font margin-right"></i> <i>Option</i></div>
                </div>
            </small></div><small>
        </small></nav><small>
        <main>
            <header>
                <h1>Article Title Goes Here</h1>
                <address>
                    <div rel="author">Author Name</div>
                </address>
            </header>
            <section id="s1">
                <h1>1. A Short Section Heading</h1>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s1-1">
                <h2>1.1. A Much Longer Section Heading That Really Goes On and On</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s1-2">
                <h2>1.2. Section Heading</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s1-3">
                <h2>1.3. Section Heading</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s2">
                <h1>2. Section Heading</h1>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s2-1">
                <h2>2.1. Section Heading</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s2-2">
                <h2>2.2. Section Heading</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s2-3">
                <h2>2.3. Section Heading</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
            <section id="s2-4">
                <h2>2.4. Section Heading</h2>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </section>
        </main>
        <nav id="page-navigation">
            <div class="sticky sidebar">
                <p class="spread">
                    <a href="#"><i class="fa fa-arrow-up margin-right"></i> Top of page</a>
                    <span id="scroll-down-indicator" style="display: none;" class="scroll-key">Fade...</span>
                </p>
                <div id="outline">
                    <div class="h1 hanging-indent"><a href="#s1"><b>1.</b> A Short Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent"><a href="#s1-1"><b>1.1.</b> A Much Longer Section Heading That Really Goes On and On</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent"><a href="#s1-2"><b>1.2.</b> Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent visible"><a href="#s1-3"><b>1.3.</b> Section Heading</a> <i style="display: inline;" class="fa fa-star superscript"></i></div>
                    <div class="h1 hanging-indent visible"><a href="#s2"><b>2.</b> Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent"><a href="#s2-1"><b>2.1.</b> Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent"><a href="#s2-2"><b>2.2.</b> Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent"><a href="#s2-3"><b>2.3.</b> Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                    <div class="h2 hanging-indent"><a href="#s2-4"><b>2.4.</b> Section Heading</a> <i style="display: none;" class="fa fa-star superscript"></i></div>
                </div>
                <p><small><i class="fa fa-star superscript"></i> <i>Last read</i></small></p><small>
            </small></div><small>
        </small></nav><small>
        <aside style="display: none;" id="console">
            <pre id="debug"></pre>
        </aside>
    </body>
    <style>
        /*
         * Colors
         */
        :root {
            font-size: 18pt;

            --icon-color: #556b2f;
            --icon-feature: #c3dec0;
            --body-color: #f5f5f5;
            --page-foreground: #303030;
            --page-background: #a8c1a6;
            --mark-background: #7b8b7a;
        }
        /*
         * Layout
         */
        body {
            color: var(--page-foreground);
            background-color: var(--page-background);
        }
        main {
            font-family: 'IBM Plex Serif', serif;
            width: 50vw;
            margin: 1rem auto;
            padding: 4vw;
            background-color: var(--body-color);
        }
        header {
            font-size: 130%;
            text-align: center;
            margin-bottom: 3rem;
        }
        nav {
            line-height: 140%;
        }
        .hanging-indent {
            padding-left: 1em;
            text-indent: -1em;
        }
        nav#site-navigation {
            font-family: 'IBM Plex Sans Condensed', sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            width: 18vw;
            margin: 1vw;
        }
        nav#page-navigation {
            font-family: 'IBM Plex Sans Condensed', sans-serif;
            position: fixed;
            top: 0;
            right: 0;
            width: 18vw;
            margin: 1vw;
        }
        nav a, nav a:visited, label {
            color: inherit;
        }
        i.fa {
            color: var(--icon-color);
        }
        div.outline i.fa {
            margin: .2rem .3rem;
        }
        mark {
            color: var(--page-foreground);
            background-color: var(--mark-background);
            font-size: smaller;
            font-weight: 400;
            border-radius: 4px;
            padding: 0 .5em;
            margin: 0 0 0 0.25em;
        }
        .spread {
            display: flex;
            justify-content: space-between;
        }
        .small-text {
            font-size: 90%;
            line-height: 130%;
        }
        .superscript {
            font-size: 70%;
            padding: 0 .25em;
            vertical-align: super;
            text-indent: 0;
        }
        aside {
            display: block;
            position: fixed;
            left: 1rem;
            bottom: 1rem;
            padding: 0.5rem;
            color: white;
            background-color: black;
        }
        .scroll-key {
            font-size: smaller;
            width: 3.2em;
            text-align: center;
            padding: 0em .3em;
            color: var(--icon-color);
            background-color: var(--icon-feature);
            border-radius: .4em;
            white-space: nowrap;
        }
        .margin-right {
            margin-right: 0.5em;
        }

        /*
         * Navbar text formats
         */
        nav a {
            color: inherit;
            text-decoration: none;
        }
        .visible {
            font-weight: bold;
            color: white;
        }
        h1 {
            font-size: 1.6rem;
            text-wrap: balance;
        }
        h2 {
            font-size: 1.4rem;
            text-wrap: balance;
        }
        h3 {
            font-size: 1.2rem;
            text-wrap: balance;
        }
        .h1 {
            text-wrap: balance;
        }
        .h2 {
            margin-left: 1em;
            text-wrap: balance;
        }
        .h3 {
            margin-left: 1em;
            text-wrap: balance;
        }

        /*
         * Animated fades
         */
        div.sidebar {
            transition: opacity 600ms;
            opacity: 1;
        }
        div.sidebar-invisible {
            opacity: 0;
        }
        /*
         * Animated blink
         */
        @keyframes blink {
            50% {
                opacity: 0.0;
            }
        }
        .blink {
            animation: blink 0.333s step-start 0.333s infinite;
        }

    </style>
    <script>
        /*
         * Modes:
         * Starts in NAVIGATE at top of screen.
         * - READ:
         *   ? User is reading and is shown no distractions
         *   - No sidebars
         *   - No timers
         *   - Stay in READ if scroll_down.
         *   - Go to NAVIGATE if scroll_up.
         * - NAVIGATE:
         *   ? User is looking for something; show site and page navigation in sidebars
         *   - Visible sidebars
         *   - No timers
         *   - Stay in NAVIGATE if scroll_up
         *   - Go to NAVIGATE_WAIT if scroll_down
         * - NAVIGATE_WAIT:
         *   ? User should still see navigation after scrolling down, but may also have stopped scrolling. Wait for activity. If none, prepare them for navigation fade-out.
         *   - Visible sidebars
         *   - Go to NAVIGATE if scroll_up
         *   - Restart NAVIGATE_WAIT if scroll_down
         *   - Start timer:
         *     - If no action for WAIT_TIME milliseconds
         *       - Go to NAVIGATE_STOP
         * - NAVIGATE_STOP:
         *   ? User should still see navigation after stopping scrolling, but be prepared for navigation to fadeout. Scrolling keeps the nav visible.
         *   - Visible scrollbars
         *   - Micro-interaction: Anticipation:
         *      - Show blinking dot to indicate imminent change
         *   - Go to NAVIGATE on scroll_up
         *   - Go to NAVIGATE_WAIT on scroll_down
         *   - Go to READ after STOP_TIME milliseconds.
         * 
         * Intervals:
         * - Every second:
         *   - Calculate most visible section. Add 1s to its current timer. If >30s, mark as current in sidebar and store in cookie.
         */
        const READ = 'READ';
        const NAVIGATE = 'NAVIGATE';
        const NAVIGATE_WAIT = 'NAVIGATE_WAIT';
        const NAVIGATE_STOP = 'NAVIGATE_STOP';

        const DOWN = 'DOWN';
        const UP = 'UP';

        const WAIT_TIME = 1000;  // For NAVIGATE_WAIT
        const STOP_TIME = 1000; // For NAVIGATE_STOP
        const BOOKMARK_TIME = 20;

        var mode = NAVIGATE;
        var oldScrollY = window.scrollY;
        var lastScroll = UP;
        var waitTimer = undefined;
        var blinkTimer = undefined;
        var visibleSections = {};
        var bookmark = '';

        window.onscroll = function(e) {
            const scroll = oldScrollY < window.scrollY ? DOWN : UP;
            oldScrollY = window.scrollY;
            if (mode === READ) {
                if (scroll === UP && lastScroll === DOWN) {
                    showSidebars();
                    mode = NAVIGATE;
                }
            } else if (mode === NAVIGATE) {
                if (scroll === DOWN) {
                    showScrollDownIndicator();
                    startWaitTimer();
                    mode = NAVIGATE_WAIT;
                }
            } else if (mode === NAVIGATE_WAIT) {
                stopWaitTimer();
                if (scroll === DOWN) {
                    startWaitTimer();
                    mode = NAVIGATE_WAIT;
                } else {
                    hideScrollDownIndicator();
                    mode = NAVIGATE;
                }
            } else if (mode === NAVIGATE_STOP) {
                startWaitTimer();
                hideScrollDownIndicator();
                stopBlinkTimer();
                if (scroll === DOWN) {
                    startWaitTimer();
                    mode = NAVIGATE_WAIT;
                } else {
                    hideScrollDownIndicator();
                    mode = NAVIGATE;
                }
            }
            lastScroll = scroll;
            updateDebugInfo();
        }

        const showSidebars = () => {
            elements = document.getElementsByClassName('sidebar');
            for (element of elements) {
                element.classList.remove('sidebar-invisible');
            }
        };

        const hideSidebars = () => {
            elements = document.getElementsByClassName('sidebar');
            for (element of elements) {
                element.classList.add('sidebar-invisible');
            }
        };

        const showScrollDownIndicator = () => {
            const span = document.getElementById('scroll-down-indicator');
            span.style.display = 'inline';
        };

        const startWaitTimer = () => {
            if (waitTimer !== undefined) {
                stopWaitTimer();
            }
            waitTimer = setTimeout(waitTimerCallback, WAIT_TIME);
            mode = NAVIGATE_WAIT;
            updateDebugInfo();
            //  console.log("Started wait timer: " + waitTimer);
        };

        const stopWaitTimer = () => {
            //  console.log("Stopping wait timer: " + waitTimer);
            clearTimeout(waitTimer);
            waitTimer = undefined;
            updateDebugInfo();
        };

        const waitTimerCallback = () => {
            makeScrollDownIndicatorBlink();
            startBlinkTimer();
            mode = NAVIGATE_STOP;
            updateDebugInfo();
        };

        const makeScrollDownIndicatorBlink = () => {
            const span = document.getElementById('scroll-down-indicator');
            span.classList.add('blink');
        };

        const hideScrollDownIndicator = () => {
            const span = document.getElementById('scroll-down-indicator');
            span.classList.remove('blink');
            span.style.display = 'none';
        };

        const startBlinkTimer = () => {
            clearTimeout(blinkTimer);
            blinkTimer = setTimeout(blinkTimerCallback, STOP_TIME);
            updateDebugInfo();
            //  console.log("Started blink timer: " + blinkTimer);
        };

        const stopBlinkTimer = () => {
            //  console.log(blinkTimer);
            clearTimeout(blinkTimer);
            blinkTimer = undefined;
            updateDebugInfo();
        };

        const blinkTimerCallback = () => {
            hideScrollDownIndicator();
            mode = READ;
            updateDebugInfo();
            hideSidebars();
        };

        const updateDebugInfo = () => {
            const data = [
                mode, 
                visibleSections,
                bookmark,
            ];
            document.getElementById('debug').innerText = JSON.stringify(data);
        }

        /*
         * Handle outline updates based on scrolling-into-view.
         */
        const handleVisibility = (events) => {
            for (event of events) {
                //  console.log(event);
                navLink = document.querySelector('[href="#' + event.target.id + '"]');
                div = navLink.closest('div');
                if (event.isIntersecting) {
                    div.classList.add('visible');
                    visibleSections[event.target.id] = 0;
                } else {
                    div.classList.remove('visible');
                    if (visibleSections[event.target.id] !== undefined) {
                        delete visibleSections[event.target.id];
                    }
                }
            }
        }
        var observer = new IntersectionObserver(handleVisibility, {
            root: null, // <-- Viewport
            rootMargin: '-15% 0% -15% 0%',
            threshold: 0,
        });
        sections = document.getElementsByTagName('section');
        for (section of sections) {
            observer.observe(section);
        }

        /*
         * Update timers based on visible sections
         */
        const incrementVisibilityTimers = () => {
            oldBookmark = bookmark;
            for (key in visibleSections) {
                visibleSections[key] += 1;
                if (visibleSections[key] > BOOKMARK_TIME) {
                    bookmark = key;
                }
                if (oldBookmark !== bookmark) {
                    updateBookmark();
                    break;
                }
            }
            updateDebugInfo();
        };
        setInterval(incrementVisibilityTimers, 1000);

        const updateBookmark = () => {
            let maxTime = 0;
            let maxKey = undefined;
            for (key in visibleSections) {
                if (visibleSections[key] > BOOKMARK_TIME) {
                    maxTime = visibleSections[key];
                    maxKey = key;
                }
            }
            if (maxKey != undefined) {
                bookmark = maxKey;
                showBookmark();
                saveBookMark();
                visibleSections = {};
            }
        };

        const showBookmark = () => {
            if (bookmark !== '') {
                //  Hide all, show selected            
                const outline = document.querySelector('div#outline');
                const icons = outline.querySelectorAll('i.fa-star');
                for (icon of icons) {
                    icon.style.display = 'none';
                }
                const navLink = document.querySelector('[href="#' + bookmark + '"]');
                const div = navLink.closest('div');
                const mark = div.querySelector('i.fa-star');
                if (mark !== null) {
                    mark.style.display = 'inline';
                }
            }
        };

        showBookmark();

        const saveBookMark = () => {
            if (bookmark !== '') {
                document.cookie = 'bookmark=' + bookmark;
            }
        };

        const loadBookmark = () => {
            const parts = document.cookie.split('=');
            if (parts[1] !== undefined) {
                bookmark = parts[1];
            } else {
                bookmark = '';
            }
        }

        loadBookmark();
        showBookmark();

    </script>

</html>
